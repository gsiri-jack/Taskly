{% extends 'base/base.html' %}

{% block dashboard %}
<script>
  function openUpdateModal(taskId) {
    fetch(`update-task/${taskId}/`)
      .then(response => response.text())
      .then(html => {
        document.getElementById("modalContent").innerHTML = html;
        new bootstrap.Modal(document.getElementById("updateTaskModal")).show();
      });
  }
  
  function submitUpdateForm(event, form) {
    event.preventDefault();
    const formData = new FormData(form);
  
    fetch(form.action, {
      method: 'POST',
      body: formData
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        location.reload();
      }
    });
  }
  </script>
    <div class="container mt-5">
        <h2 class="">Hi {{username}}..! </h2>
        <p class="">Your task management solution.</p>
        <hr>
        {% for task in tasks %}
        
            <div class="taskCard mb-3">
                <input type="checkbox" class="form-check-input" name="status" id="">
                <div class="tsci">
                    <div class="">
                   
                      <h5 class="card-title">
                        {{ task.title }} 
                        {% if task.status == 'completed' %}
                          <span class="badge bg-success ms-2">Completed</span>
                        {% else %}
                          <i class="bi bi-flag-fill text-danger ms-2"></i>
                        {% endif %}
                      </h5>
                      
                      <p class="card-text">{{ task.description }}</p>
                      <p class="card-text"><small class="text-muted">Due: {{ task.due_date }}</small></p>
                      
                      <div class="mb-2">
                        {% for tag in task.tags.all %}
                          <span class="badge bg-primary me-1">{{ tag.tag_name }}</span>
                        {% empty %}
                          <span class="text-muted">No tags</span>
                        {% endfor %}
                      </div>
                      
                        
           
                    </div>
                   <div>
                    <a href="{% url 'task_detail' task.id %}" ><i class="bi bi-pencil-square"></i></a>
                    <a href="{% url 'delete_task' task.id %}" > <i class="bi bi-trash3"></i></a>
                    <a href="#" onclick="openUpdateModal({{task.id}})">Update</a>

                   
                   </div>
                </div>
            </div>
            <hr>
        {% endfor %}
    
<a href="" class='link_btn' data-bs-toggle="modal" data-bs-target="#createTaskModal">
    <i class="bi bi-plus-circle"></i> Add Task
  </a>
  <div style="height: 10vh;">&nbsp;</div>
  
  <ul>
    {% for task in tasks %}
      <li>
        <input type="checkbox" {% if task.completed %}checked{% endif %} onchange="toggleTask({{ task.id }}, this)">
        <span class="{% if task.completed %}completed{% endif %}">{{ task.title }}</span>
      </li>
    {% endfor %}
  </ul>
  
  <script>
    function toggleTask(taskId, checkbox) {
      fetch(`/toggle-task/${taskId}/`)
        .then(response => response.json())
        .then(data => {
          if (data.completed) {
            checkbox.nextElementSibling.classList.add('completed');
          } else {
            checkbox.nextElementSibling.classList.remove('completed');
          }
        });
    }
  </script>
  
  
    </div>

    <div class="modal fade" id="createTaskModal" tabindex="-1" aria-labelledby="createTaskModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content rounded-4 shadow-sm">
          {% include 'base/create_task_form.html' %}
          </div>
        </div>
      </div>

<div class="modal fade" id="updateTaskModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content" id="modalContent">
      <!-- form will load here -->
    </div>
  </div>
</div>

{% endblock %}